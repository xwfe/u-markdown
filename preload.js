const{clipboard}=require("electron"),path=require("path"),fs=require("fs"),url=require("url"),crypto=require("crypto"),attachmentCacheDir=path.join(window.utools.getPath("temp"),"utools.notes"),attachmentExtCache={},imageMimeDic={"image/bmp":".bmp","image/gif":".gif","image/vnd.microsoft.icon":".ico","image/jpeg":".jpg","image/png":".png","image/svg+xml":".svg","image/tiff":".tiff","image/webp":".webp"};function waitTime(t){return new Promise((e=>{setTimeout(e,t)}))}function writeNoteFile(t,e,a,i,n,o){const r=!t;let s;if(e=e.replace(/[/\\]/g,"").trim()||Date.now().toString(),i.length>0){if(!t){if(!(t=window.utools.showSaveDialog({defaultPath:path.join(window.utools.getPath("downloads")||"",e)})))return;try{fs.existsSync(t)&&fs.lstatSync(t).isDirectory()||fs.mkdirSync(t,{recursive:!0})}catch(e){throw new Error(`无法创建文件夹 "${t}" — ${e.message}`)}}if(s=path.join(t,e+"."+n),i.forEach((e=>{try{fs.copyFileSync(e,path.join(t,path.basename(e)))}catch{}})),"html"===n&&o)try{const e=path.join(__dirname,"fonts"),a=fs.readdirSync(e),i=path.join(t,"fonts");fs.existsSync(i)||fs.mkdirSync(i);for(const t of a)fs.copyFileSync(path.join(e,t),path.join(i,t))}catch{}}else if(t)s=path.join(t,e+"."+n);else{const t=path.join(window.utools.getPath("downloads")||"",e+"."+n);if(s=window.utools.showSaveDialog({defaultPath:t,filters:[{name:"md"===n?"Markdown":n,extensions:[n]}]}),!s)return}try{fs.writeFileSync(s,a,"utf8")}catch(t){throw new Error(`内容无法写入文件 "${s}" — ${t.message}`)}r&&setTimeout((()=>{window.utools.hideMainWindow(!1),window.utools.shellShowItemInFolder(s)}),500)}window.IS_MACOS=window.utools.isMacOS(),window.NATIVEID=window.utools.getNativeId(),window.services={getFirstMDFileContent:()=>fs.readFileSync(path.join(__dirname,"first.md"),{encoding:"utf-8"}),readClipboardHtml:()=>clipboard.readHTML(),readClipboardData:()=>({text:clipboard.readText(),html:clipboard.readHTML()}),writeClipboardData:t=>{t&&clipboard.write(t)},makeFolder:(t,e)=>{const a=path.join(t,e);return fs.existsSync(a)||fs.mkdirSync(a,{recursive:!0}),a},writeMarkdownFile:(t,e,a,i)=>{writeNoteFile(t,e,a,i,"md")},writeHtmlFile:(t,e,a,i,n)=>{n&&i.push(path.join(__dirname,"katex.min.css")),writeNoteFile(null,t,`<!doctype html>\n      <html>\n      <head>\n        <meta charset="utf-8"/>\n        <title>${t||""}</title>\n        ${n?'<link rel="stylesheet" href="./katex.min.css">':""}\n        <style>\n          html, body { margin: 0; padding: 0; background-color: #ffffff; }\n          .markdown-body { box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; padding: 45px; }\n          @media (max-width: 767px) { .markdown-body { padding: 15px; } }\n          ${fs.readFileSync(path.join(__dirname,"export-file","github-markdown.css"),"utf-8")}\n          ${a}\n        </style>\n      </head>\n      <body>\n        <article class="markdown-body">\n          ${e}\n        </article>\n      </body>\n      </html>`,i,"html",n)},copyHtml:t=>{clipboard.writeHTML(t)},exportFile:(t,e,a,i)=>{const n=window.utools.createBrowserWindow("export-file/index.html",{width:980,height:600,show:!1},(async()=>{try{let o;if(await waitTime(50),a&&await n.webContents.insertCSS(a),await n.webContents.executeJavaScript(`\n          document.querySelector('.markdown-body').innerHTML = ${JSON.stringify(e)}\n        `),await n.webContents.executeJavaScript("window.waitAllImageLoaded()"),await waitTime(50),"image"===t){const t=await n.webContents.executeJavaScript("document.body.scrollHeight");n.setContentSize(980,t+25),await waitTime(50),o=await n.webContents.capturePage(),o.toPNG&&(o=o.toPNG())}else o=await n.webContents.printToPDF({marginsType:0,printBackground:!0,printSelectionOnly:!1,landscape:!1,pageSize:"A4",scaleFactor:100});n.destroy();const r=path.join(window.utools.getPath("temp"),"utools_notes_export_"+Date.now()+("image"===t?".png":".pdf"));fs.writeFileSync(r,o),i(null,r)}catch(t){n.destroy(),i(t)}}))},dialogSaveExportFile:(t,e,a)=>{e=e.replace(/[/\\]/g,"").trim()||Date.now().toString();const i=path.join(window.utools.getPath("downloads")||"",e+path.extname(t)),n=window.utools.showSaveDialog({defaultPath:i,filters:[{name:a[0].toUpperCase()+a.substr(1),extensions:["image"===a?"png":a]}]});if(n)try{fs.renameSync(t,n),setTimeout((()=>{window.utools.hideMainWindow(!1),window.utools.shellShowItemInFolder(n)}),1e3)}catch(e){const a=fs.createReadStream(t),i=fs.createWriteStream(n);a.on("close",(function(){try{fs.unlinkSync(t)}catch(t){}setTimeout((()=>{window.utools.hideMainWindow(!1),window.utools.shellShowItemInFolder(n)}),1e3)})),a.pipe(i)}},getImageData:t=>{let e,a,i;if(/^(data:(image\/(?:png|jpg|jpeg));base64,)/i.test(t))e=Buffer.from(t.replace(RegExp.$1,""),"base64"),a=RegExp.$2.toLowerCase(),i="screen-capture";else{if(!fs.existsSync(t))throw new Error("图片文件不存在");const n=fs.lstatSync(t),o=path.extname(t).toLowerCase();if(![".png",".jpe",".jpg",".jpeg",".bmp",".gif",".svg",".ico",".webp"].includes(o))throw new Error("非图片格式文件");if(n.size>10485760)throw new Error("图片大小超过 10 M");e=fs.readFileSync(t),a="image/"+o.replace(".",""),i=path.basename(t)}return{digest:crypto.createHash("md5").update(e).digest("hex"),name:i,data:e,contentType:a}},getClipboardImage:()=>{const t=window.utools.getCopyedFiles();if(t){if(t.length>1)throw new Error("存在多个文件，请复制粘贴一个图片文件");return window.services.getImageData(t[0].path)}const e=clipboard.availableFormats();if(0===e.length||"text/plain"===e[0])return null;if(e[e.length-1].startsWith("image/")){const t=clipboard.readImage();if(t&&!t.isEmpty()){const e=t.toPNG();if(e.byteLength>10485760)throw new Error("图片大小超过 10 M");return{digest:crypto.createHash("md5").update(e).digest("hex"),name:"截图",data:e,contentType:"image/png"}}}return null},getAttachmentTempPath:t=>{let e;if(t in attachmentExtCache)e=attachmentExtCache[t];else{const a=window.utools.db.get("attachment/"+t);a&&(e=a._attachments[0].content_type.replace("image/",".")),attachmentExtCache[t]=e}const a=path.join(attachmentCacheDir,t)+(e||"");if(fs.existsSync(a))return a;const i=window.utools.db.getAttachment("attachment/"+t);if(!i)return null;fs.existsSync(attachmentCacheDir)||fs.mkdirSync(attachmentCacheDir);try{fs.writeFileSync(a,i)}catch(t){return null}return a},getFileBaseName:t=>path.basename(t),getFileContent:t=>{try{return fs.readFileSync(t,"utf-8")}catch(t){return""}},fileUrlToPath:t=>url.fileURLToPath(t),saveImgToFileBySrc:async t=>{let e,a;if(/^data:(image\/[a-z]+?);base64,/i.test(t)){if(a=imageMimeDic[RegExp.$1.toLowerCase()],!a)return null;e=Buffer.from(t.replace(/^data:(image\/[a-z]+?);base64,/i,""),"base64")}else{if(!/^https?:\/\//i.test(t))return null;{const i=await window.fetch(t),n=await i.blob();if(a=imageMimeDic[n.type],!a)return null;const o=await n.arrayBuffer();e=Buffer.from(new Uint8Array(o))}}const i=crypto.createHash("md5").update(e).digest("hex"),n=path.join(attachmentCacheDir,i)+a;if(fs.existsSync(n))return n;fs.existsSync(attachmentCacheDir)||fs.mkdirSync(attachmentCacheDir);try{fs.writeFileSync(n,e)}catch(t){return null}return n},shellOpenPath:t=>{setTimeout((()=>{try{if(!fs.existsSync(t))return void window.utools.showNotification('"'+t+'" 路径不存在!')}catch(t){return}window.utools.shellOpenPath(t)}))},convertMdFileImageURLToAbsolutePath:(t,e)=>{const a=path.join(path.dirname(t),e);return fs.existsSync(a)?a:null}};